<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½è¡Œæƒ…çœ‹æ¿</title>
    <!-- å¼•å…¥å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒæ ·å¼ --- */
        :root { --bg: #1e1e1e; --card: #2d2d2d; --text: #e0e0e0; --red: #ff4d4d; --green: #00e676; --blue: #2979ff; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        
        /* é¡¶éƒ¨æ€»è§ˆ */
        .header { background: linear-gradient(180deg, #141414, #1e1e1e); padding: 20px; border-bottom: 1px solid #333; }
        .total-box { text-align: center; }
        .total-lbl { font-size: 12px; color: #888; margin-bottom: 5px; }
        .total-val { font-size: 32px; font-weight: bold; letter-spacing: 1px; }
        .summary-row { display: flex; margin-top: 15px; justify-content: space-around; }
        .s-item { text-align: center; }
        .s-val { font-size: 16px; font-weight: bold; }

        /* åˆ—è¡¨ */
        .container { padding: 15px; max-width: 640px; margin: 0 auto; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative; overflow: hidden; }
        
        /* å·¦ä¾§ï¼šåç§°ä»£ç  */
        .c-left { display: flex; flex-direction: column; }
        .name { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: #fff; }
        .code { font-size: 12px; color: #666; background: #1a1a1a; padding: 2px 6px; border-radius: 4px; align-self: flex-start; }
        
        /* ä¸­é—´ï¼šæŒä»“æ”¶ç›Š */
        .c-mid { text-align: center; flex: 1; display: flex; flex-direction: column; }
        .profit-lbl { font-size: 10px; color: #888; }
        .profit-val { font-size: 14px; font-weight: bold; }

        /* å³ä¾§ï¼šä»·æ ¼æ¶¨å¹… */
        .c-right { text-align: right; }
        .price { font-size: 18px; font-weight: bold; }
        .percent { font-size: 12px; padding: 2px 6px; border-radius: 4px; color: #fff; display: inline-block; margin-top: 4px; }

        /* é¢œè‰²ç±» */
        .up { color: var(--red); }
        .down { color: var(--green); }
        .bg-up { background: rgba(255, 77, 77, 0.2); }
        .bg-down { background: rgba(0, 230, 118, 0.2); }
        
        /* æŒ‰é’® */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: var(--blue); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 99; }
        .fab-refresh { position: fixed; bottom: 30px; left: 30px; width: 40px; height: 40px; background: #333; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 99; transition: 0.5s; }

        /* å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #2d2d2d; padding: 20px; border-radius: 15px; width: 85%; max-width: 320px; color: #fff; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .tips { font-size: 11px; color: #666; margin-bottom: 15px; line-height: 1.5; }
        
        .btn-row { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--blue); color: white; }
        .btn-cancel { background: #444; color: #ccc; }
        .btn-del { background: #3e2020; color: var(--red); flex: 0.3; }

        /* Kçº¿å›¾å¼¹çª— */
        .chart-modal { width: 95%; max-width: 500px; height: 350px; }
        #kline { width: 100%; height: 300px; }

    </style>
</head>
<body>

<div class="header">
    <div class="total-box">
        <div class="total-lbl">æ€»æŒä»“å¸‚å€¼</div>
        <div class="total-val" id="t-asset">0.00</div>
    </div>
    <div class="summary-row">
        <div class="s-item">
            <div class="total-lbl">æ€»ç›ˆäº</div>
            <div class="s-val" id="t-profit">0.00</div>
        </div>
        <div class="s-item">
            <div class="total-lbl">ä»Šæ—¥å˜åŠ¨</div>
            <div class="s-val" id="t-day">0.00</div>
        </div>
    </div>
</div>

<div class="container" id="list"></div>

<div class="fab-refresh" onclick="refresh()">ğŸ”„</div>
<div class="fab" onclick="edit(-1)">+</div>

<!-- ç¼–è¾‘å¼¹çª— -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h3 style="margin-top:0">æ·»åŠ /ä¿®æ”¹</h3>
        
        <div class="input-group">
            <label>ä»£ç  (å‰ç¼€: sh/sz/hk/us)</label>
            <input type="text" id="in-code" placeholder="ä¾‹: sh510300, sz000858">
        </div>
        <div class="tips">
            <b>ğŸ’¡ ä»£ç è§„åˆ™ï¼š</b><br>
            ä¸Šæµ·è‚¡ç¥¨/ETF/LOF â†’ <b>sh</b> (å¦‚ sh600519, sh510300)<br>
            æ·±åœ³è‚¡ç¥¨/ETF â†’ <b>sz</b> (å¦‚ sz000858, sz159915)<br>
            æ¸¯è‚¡ â†’ <b>hk</b> (å¦‚ hk00700)<br>
            ç¾è‚¡ â†’ <b>us</b> (å¦‚ usAAPL)
        </div>

        <div class="input-group">
            <label>æŒæœ‰è‚¡æ•°</label>
            <input type="number" id="in-share" placeholder="0">
        </div>
        <div class="input-group">
            <label>æˆæœ¬å•ä»· (å…ƒ)</label>
            <input type="number" id="in-cost" placeholder="ä¹°å…¥æ—¶çš„å•ä»·">
        </div>

        <div class="btn-row">
            <button class="btn btn-del" id="btn-del" onclick="del()" style="display:none">åˆ </button>
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="save()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- åˆ†æ—¶å›¾å¼¹çª— -->
<div class="modal" id="chartModal">
    <div class="modal-content chart-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="chart-name" style="font-weight:bold"></span>
            <span onclick="document.getElementById('chartModal').style.display='none'" style="cursor:pointer">âœ•</span>
        </div>
        <div id="kline"></div>
        <div style="text-align:center; font-size:10px; color:#666">è…¾è®¯è´¢ç»æ¥å£ Â· å®æ—¶åˆ†æ—¶</div>
    </div>
</div>

<script>
    // æ ¸å¿ƒæ•°æ®
    let stocks = JSON.parse(localStorage.getItem('myStocks')) || [];
    let marketData = {};
    let editIdx = -1;
    let chartInstance = null;

    // 1. è·å–è…¾è®¯è´¢ç»å®æ—¶è¡Œæƒ… (æ”¯æŒå¤šåªä¸€èµ·æŸ¥)
    function refresh() {
        if(stocks.length === 0) return;
        
        // æ—‹è½¬å›¾æ ‡
        const btn = document.querySelector('.fab-refresh');
        btn.style.transform = 'rotate(360deg)';
        setTimeout(()=> btn.style.transform='rotate(0deg)', 500);

        // æ‹¼æ¥ä»£ç 
        const codes = stocks.map(s => s.code).join(',');
        
        const script = document.createElement('script');
        // è…¾è®¯æ¥å£: qt.gtimg.cn
        script.src = `https://qt.gtimg.cn/q=${codes}&t=${Date.now()}`;
        
        // è…¾è®¯æ¥å£è¿”å›çš„æ˜¯ var v_sh600519="..."; è¿™ç§æ ¼å¼
        // æˆ‘ä»¬åˆ©ç”¨å›è°ƒå¤„ç†
        script.onload = () => {
            stocks.forEach(s => {
                // å˜é‡åè§„åˆ™: v_ä»£ç 
                const varName = 'v_' + s.code; 
                if(window[varName]) {
                    // è§£ææ•°æ®: "1:åç§°~2:ä»£ç ~3:å½“å‰ä»·~4:æ˜¨æ”¶~5:å¼€ç›˜..."
                    const arr = window[varName].split('~');
                    marketData[s.code] = {
                        name: arr[1],
                        price: parseFloat(arr[3]),
                        prevClose: parseFloat(arr[4]),
                        pct: parseFloat(arr[32]), // æ¶¨è·Œå¹…%
                        time: arr[30]
                    };
                }
            });
            render();
            // æ¸…ç†å…¨å±€å˜é‡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            stocks.forEach(s => { try{ delete window['v_'+s.code]; }catch(e){} });
        };
        document.body.appendChild(script);
        setTimeout(() => script.remove(), 2000); // æ¸…ç†DOM
    }

    // 2. æ¸²æŸ“åˆ—è¡¨
    function render() {
        const list = document.getElementById('list');
        list.innerHTML = '';
        
        let tAsset = 0, tProfit = 0, tDay = 0;

        stocks.forEach((s, idx) => {
            const m = marketData[s.code];
            if(!m) return; // æ•°æ®è¿˜æ²¡å›æ¥

            const curVal = m.price * s.share;
            const costVal = s.cost * s.share;
            const profit = curVal - costVal; // æ€»ç›ˆäº
            // ä»Šæ—¥å˜åŠ¨ = (å½“å‰ä»· - æ˜¨æ”¶) * è‚¡æ•°
            const dayChange = (m.price - m.prevClose) * s.share;

            tAsset += curVal;
            tProfit += profit;
            tDay += dayChange;

            const isUp = m.pct >= 0;
            const color = isUp ? 'up' : 'down';
            const bg = isUp ? 'bg-up' : 'bg-down';
            const sign = isUp ? '+' : '';

            list.innerHTML += `
                <div class="card" onclick="showChart('${s.code}', '${m.name}', ${idx})">
                    <div class="c-left">
                        <div class="name">${m.name}</div>
                        <div class="code">${s.code}</div>
                    </div>
                    <div class="c-mid">
                        <span class="profit-val ${profit>=0?'up':'down'}">${profit>0?'+':''}${profit.toFixed(0)}</span>
                        <span class="profit-lbl">æŒä»“ç›ˆäº</span>
                    </div>
                    <div class="c-right">
                        <div class="price ${color}">${m.price.toFixed(m.price<10?3:2)}</div>
                        <div class="percent ${bg} ${color}">${sign}${m.pct}%</div>
                    </div>
                </div>
            `;
        });

        // æ›´æ–°é¡¶éƒ¨
        document.getElementById('t-asset').innerText = tAsset.toLocaleString('zh-CN', {minimumFractionDigits:2});
        updateHead('t-profit', tProfit);
        updateHead('t-day', tDay);
    }

    function updateHead(id, val) {
        const el = document.getElementById(id);
        el.innerText = (val>0?'+':'') + val.toLocaleString('zh-CN', {minimumFractionDigits:2});
        el.className = 's-val ' + (val>=0?'up':'down');
    }

    // 3. ç¼–è¾‘åŠŸèƒ½
    function edit(idx) {
        // å¦‚æœæ˜¯ç‚¹å‡»å¡ç‰‡è¿›å…¥å›¾è¡¨ï¼Œé•¿æŒ‰æˆ–è€…ç‚¹æŒ‰é’®æ‰æ˜¯ç¼–è¾‘ï¼Ÿ
        // è¿™é‡Œç®€åŒ–ï¼šåªæœ‰ç‚¹+å·æ‰æ˜¯æ–°å¢ã€‚
        // ä¸ºäº†æ”¯æŒç¼–è¾‘ï¼Œæˆ‘ä»¬åœ¨å›¾è¡¨é¡µåŠ ä¸ªç¼–è¾‘å…¥å£ï¼Œæˆ–è€…ç‚¹+å·æ—¶åˆ¤æ–­
        editIdx = idx;
        const modal = document.getElementById('editModal');
        const delBtn = document.getElementById('btn-del');

        if(idx === -1) {
            document.getElementById('in-code').value = '';
            document.getElementById('in-share').value = '';
            document.getElementById('in-cost').value = '';
            document.getElementById('in-code').disabled = false;
            delBtn.style.display = 'none';
        } else {
            // ç¼–è¾‘é€»è¾‘ï¼Œè¿™é‡Œæš‚æ—¶åªåšæ–°å¢æ¼”ç¤ºï¼Œè‹¥è¦ç¼–è¾‘éœ€ä¿®æ”¹UIäº¤äº’
        }
        modal.style.display = 'flex';
    }

    function save() {
        const code = document.getElementById('in-code').value.trim();
        const share = parseFloat(document.getElementById('in-share').value);
        const cost = parseFloat(document.getElementById('in-cost').value);
        
        if(!code || isNaN(share) || isNaN(cost)) return alert('è¯·å¡«å…¨ä¿¡æ¯');
        
        // ç®€å•çš„é‡å¤æ£€æŸ¥
        if(editIdx === -1) {
            stocks.push({code, share, cost});
        }
        localStorage.setItem('myStocks', JSON.stringify(stocks));
        closeModal();
        refresh();
    }

    function closeModal() { document.getElementById('editModal').style.display = 'none'; }
    function del() {} // ç®€åŒ–ç‰ˆ

    // 4. æ˜¾ç¤ºåˆ†æ—¶å›¾ (è°ƒç”¨æ–°æµªè´¢ç»å›¾ç‰‡æ¥å£ï¼Œæœ€ç®€å•ç²—æš´)
    function showChart(code, name, idx) {
        // è¿™é‡Œå¦‚æœæ˜¯ä¸ºäº†ç¼–è¾‘ï¼Œå¯ä»¥åœ¨å¼¹çª—é‡ŒåŠ ä¸ªæŒ‰é’®ã€‚
        // ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥å¼¹å›¾è¡¨
        const modal = document.getElementById('chartModal');
        modal.style.display = 'flex';
        document.getElementById('chart-name').innerText = name + ' (' + code + ')';
        
        const container = document.getElementById('kline');
        container.innerHTML = ''; // æ¸…ç©º

        // åˆ¤æ–­å¸‚åœºç±»å‹
        let imgUrl = '';
        if(code.startsWith('sh') || code.startsWith('sz')) {
            // Aè‚¡/ETFåˆ†æ—¶å›¾
            const symbol = code; 
            imgUrl = `https://image.sinajs.cn/newchart/min/n/${symbol}.gif?t=${Date.now()}`;
        } else if(code.startsWith('hk')) {
            // æ¸¯è‚¡
            imgUrl = `https://image.sinajs.cn/newchart/hk_stock/min/${code.substring(2)}.gif`;
        } else if(code.startsWith('us')) {
            // ç¾è‚¡
            imgUrl = `https://image.sinajs.cn/newchart/usstock/min/${code.substring(2)}.gif`;
        }

        // åˆ›å»ºå›¾ç‰‡
        const img = new Image();
        img.src = imgUrl;
        img.style.width = '100%';
        img.style.borderRadius = '8px';
        container.appendChild(img);
        
        // æ·»åŠ é•¿æŒ‰åˆ é™¤/ç¼–è¾‘çš„æç¤ºæˆ–æŒ‰é’®ï¼ˆç®€åŒ–ç‰ˆçœç•¥ï¼‰
        const editBtn = document.createElement('div');
        editBtn.innerText = "ğŸ—‘ åˆ é™¤ / âœï¸ ä¿®æ”¹";
        editBtn.style.textAlign = 'center';
        editBtn.style.padding = '10px';
        editBtn.style.color = '#888';
        editBtn.style.cursor = 'pointer';
        editBtn.onclick = () => {
             if(confirm('åˆ é™¤è¿™ä¸ªæŒä»“å—ï¼Ÿ')) {
                 stocks.splice(idx, 1);
                 localStorage.setItem('myStocks', JSON.stringify(stocks));
                 modal.style.display = 'none';
                 refresh();
             }
        };
        container.appendChild(editBtn);
    }

    // è‡ªåŠ¨åˆ·æ–°
    refresh();
    setInterval(refresh, 5000); // è‚¡ç¥¨æ³¢åŠ¨å¿«ï¼Œ5ç§’åˆ·ä¸€æ¬¡

</script>
</body>
</html>
