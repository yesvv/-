<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„åŸºé‡‘å®ç›˜Pro+</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        :root { --bg: #f5f7fa; --card: #fff; --text: #333; --blue: #409eff; --red: #f56c6c; --green: #67c23a; }
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        
        /* é¡¶éƒ¨èµ„äº§å¡ç‰‡ */
        .header { background: linear-gradient(135deg, #409eff, #3a8ee6); color: white; padding: 25px 20px 30px; border-radius: 0 0 24px 24px; box-shadow: 0 4px 12px rgba(64,158,255,0.3); }
        .total-asset { font-size: 36px; font-weight: 700; margin: 10px 0 20px; }
        .summary-box { display: flex; background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; backdrop-filter: blur(5px); }
        .s-item { flex: 1; text-align: center; }
        .s-val { font-size: 16px; font-weight: 600; }
        .s-lbl { font-size: 11px; opacity: 0.8; margin-bottom: 4px; }

        /* åˆ—è¡¨å®¹å™¨ */
        .container { padding: 0 16px; margin-top: -20px; max-width: 640px; margin-left: auto; margin-right: auto; }
        
        /* åŸºé‡‘å¡ç‰‡ */
        .fund-card { background: var(--card); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; }
        .c-top { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .f-name { font-weight: 600; font-size: 15px; color: #2c3e50; }
        .f-code { font-size: 12px; color: #999; background: #f4f4f5; padding: 1px 5px; border-radius: 4px; margin-left: 5px; }
        .f-gsz { font-size: 18px; font-weight: 700; }
        
        /* æ•°æ®ç½‘æ ¼ */
        .c-grid { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; }
        .g-val { font-size: 14px; font-weight: 600; }
        .g-lbl { font-size: 10px; color: #909399; margin-bottom: 4px; }

        /* æ“ä½œæŒ‰é’®åŒº */
        .card-actions { display: flex; justify-content: flex-end; margin-top: 12px; gap: 8px; }
        .btn-pill { font-size: 12px; padding: 6px 14px; border-radius: 20px; border: 1px solid #eee; background: #fff; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .btn-chart { color: var(--blue); border-color: #d9ecff; background-color: #ecf5ff; }
        .btn-edit { color: #909399; }
        .btn-pill:active { transform: scale(0.95); }

        /* é¢œè‰²è¾…åŠ© */
        .red { color: var(--red); } .green { color: var(--green); }
        .bg-red { background: rgba(245, 108, 108, 0.03); } .bg-green { background: rgba(103, 194, 58, 0.03); }

        /* æ‚¬æµ®æŒ‰é’® */
        .fab-add { position: fixed; bottom: 30px; right: 30px; width: 56px; height: 56px; background: var(--blue); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 15px rgba(64,158,255,0.4); cursor: pointer; z-index: 90; }
        .fab-refresh { position: fixed; bottom: 30px; left: 30px; width: 48px; height: 48px; background: #fff; border-radius: 50%; color: var(--blue); display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 90; transition: transform 0.5s; }

        /* é€šç”¨å¼¹çª—è’™å±‚ */
        .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        
        /* 1. ç¼–è¾‘å¼¹çª— */
        .edit-box { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 20px; animation: pop 0.2s; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #f9f9f9; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-save { background: var(--blue); color: white; }
        .btn-cancel { background: #f4f4f5; color: #909399; }
        .btn-del { background: #fef0f0; color: var(--red); flex: 0.4; }

        /* 2. å›¾è¡¨å¼¹çª— (å¤§) */
        .chart-box { background: white; width: 95%; height: 80vh; max-width: 500px; border-radius: 16px; padding: 15px; animation: pop 0.2s; display: flex; flex-direction: column; position: relative; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .chart-title { font-weight: bold; font-size: 16px; color: #333; }
        .close-chart { font-size: 24px; color: #999; cursor: pointer; padding: 0 10px; }
        
        /* Tab åˆ‡æ¢ */
        .tab-group { display: flex; background: #f0f2f5; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .tab-btn { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; color: #666; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--blue); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* å›¾è¡¨å†…å®¹åŒº */
        .chart-content { flex: 1; position: relative; border-radius: 8px; overflow: hidden; background: #fff; }
        #echart-view { width: 100%; height: 100%; }
        #iframe-view { width: 100%; height: 100%; border: none; display: none; }
        
        @keyframes pop { from {transform: scale(0.95); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨ -->
    <div class="header">
        <h3 style="margin:0; opacity:0.8; font-weight:normal">æ€»èµ„äº§ (å…ƒ)</h3>
        <div class="total-asset" id="h-total">0.00</div>
        <div class="summary-box">
            <div class="s-item">
                <div class="s-lbl">æŒæœ‰æ”¶ç›Š</div>
                <div class="s-val" id="h-profit">0.00</div>
            </div>
            <div class="s-item">
                <div class="s-lbl">ä»Šæ—¥é¢„ä¼°</div>
                <div class="s-val" id="h-today">0.00</div>
            </div>
        </div>
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="container" id="list-area"></div>
    <div style="text-align:center; margin-top:30px; font-size:12px; color:#ccc;">æ•°æ®æ¥æºï¼šå¤©å¤©åŸºé‡‘ | è‡ªåŠ¨æ¯30ç§’åˆ·æ–°</div>

    <!-- æ‚¬æµ®æŒ‰é’® -->
    <div class="fab-refresh" onclick="refreshData()">ğŸ”„</div>
    <div class="fab-add" onclick="openEdit(-1)">+</div>

    <!-- å¼¹çª—1ï¼šç¼–è¾‘æŒä»“ -->
    <div class="modal-mask" id="editModal">
        <div class="edit-box">
            <h3 style="margin-top:0; text-align:center" id="m-title">æŒä»“ç¼–è¾‘</h3>
            <input type="tel" class="form-input" id="in-code" placeholder="åŸºé‡‘ä»£ç  (å¦‚ 000001)" maxlength="6">
            <input type="number" class="form-input" id="in-share" placeholder="æŒæœ‰ä»½é¢">
            <input type="number" class="form-input" id="in-cost" placeholder="æ€»æŠ•å…¥æœ¬é‡‘">
            <div class="btn-group">
                <button class="btn btn-del" id="btn-del" onclick="doDel()" style="display:none">åˆ </button>
                <button class="btn btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
                <button class="btn btn-save" onclick="doSave()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—2ï¼šèµ°åŠ¿å›¾ (åŒæ¨¡å¼) -->
    <div class="modal-mask" id="chartModal">
        <div class="chart-box">
            <div class="chart-header">
                <div class="chart-title" id="chart-name">åŸºé‡‘èµ°åŠ¿</div>
                <div class="close-chart" onclick="closeChart()">Ã—</div>
            </div>
            
            <div class="tab-group">
                <div class="tab-btn active" id="tab-1" onclick="switchTab(1)">ğŸ“Š è¿‘3æœˆå‡€å€¼</div>
                <div class="tab-btn" id="tab-2" onclick="switchTab(2)">âš¡ ä»Šæ—¥å®æ—¶ä¼°å€¼</div>
            </div>

            <div class="chart-content">
                <!-- æ¨¡å¼1: ECharts -->
                <div id="echart-view"></div>
                <!-- æ¨¡å¼2: Iframe -->
                <iframe id="iframe-view" src=""></iframe>
            </div>
        </div>
    </div>

<script>
    // --- æ•°æ®ä¸é…ç½® ---
    let myFunds = JSON.parse(localStorage.getItem('myFunds')) || [];
    let fundCache = {};
    let editIdx = -1;
    let myChart = null; // EChartså®ä¾‹
    let currentChartCode = ''; // å½“å‰æŸ¥çœ‹çš„åŸºé‡‘ä»£ç 

    // 1. å›è°ƒå‡½æ•°
    function jsonpgz(data) {
        if(data && data.fundcode) {
            fundCache[data.fundcode] = data;
            renderList();
        }
    }

    // 2. è·å–æ•°æ®
    function fetchRealtime(code) {
        const script = document.createElement('script');
        script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${Date.now()}`;
        script.onerror = () => console.warn('è·å–å¤±è´¥:', code);
        document.body.appendChild(script);
        setTimeout(() => script.remove(), 3000);
    }

    function refreshData() {
        if(myFunds.length === 0) return;
        const btn = document.querySelector('.fab-refresh');
        btn.style.transform = "rotate(360deg)";
        setTimeout(() => btn.style.transform = "rotate(0deg)", 500);
        myFunds.forEach(f => fetchRealtime(f.code));
    }

    // 3. æ¸²æŸ“åˆ—è¡¨
    function renderList() {
        const el = document.getElementById('list-area');
        el.innerHTML = '';
        let sAsset=0, sProfit=0, sToday=0;

        myFunds.forEach((f, idx) => {
            const d = fundCache[f.code];
            let name = d ? d.name : 'åŠ è½½ä¸­...';
            let gsz = d ? parseFloat(d.gsz) : 0;
            let zz = d ? parseFloat(d.gszzl) : 0;
            let time = d ? d.gztime : '--';

            let curVal = f.share * gsz;
            let profit = curVal - f.cost;
            let today = 0;
            
            if(gsz > 0) {
                today = (curVal / (1 + zz/100)) * (zz/100);
                sAsset += curVal;
                sProfit += profit;
                sToday += today;
            }

            const isUp = zz >= 0;
            const color = isUp ? 'red' : 'green';
            const bg = isUp ? 'bg-red' : 'bg-green';

            el.innerHTML += `
                <div class="fund-card ${bg}">
                    <div class="c-top">
                        <div>
                            <span class="f-name">${name}</span>
                            <span class="f-code">${f.code}</span>
                        </div>
                        <div style="text-align:right">
                            <div class="f-gsz ${color}">${gsz.toFixed(4)}</div>
                            <div style="font-size:10px; color:#ccc">${time}</div>
                        </div>
                    </div>
                    <div class="c-grid">
                        <div><div class="g-lbl">ä¼°ç®—æ¶¨å¹…</div><div class="g-val ${color}">${isUp?'+':''}${zz}%</div></div>
                        <div><div class="g-lbl">æŒæœ‰æ”¶ç›Š</div><div class="g-val ${profit>=0?'red':'green'}">${profit>0?'+':''}${profit.toFixed(1)}</div></div>
                        <div><div class="g-lbl">ä»Šæ—¥é¢„ä¼°</div><div class="g-val ${color}">${today>0?'+':''}${today.toFixed(1)}</div></div>
                    </div>
                    <div class="card-actions">
                        <div class="btn-pill btn-chart" onclick="openChart('${f.code}', '${name}')">
                            ğŸ“ˆ çœ‹èµ°åŠ¿
                        </div>
                        <div class="btn-pill btn-edit" onclick="openEdit(${idx})">
                            âœï¸ ç¼–è¾‘
                        </div>
                    </div>
                </div>
            `;
        });

        // é¡¶éƒ¨æ•°æ®
        document.getElementById('h-total').innerText = sAsset.toLocaleString('zh-CN', {minimumFractionDigits:2});
        updateHead('h-profit', sProfit);
        updateHead('h-today', sToday);
    }

    function updateHead(id, val) {
        const el = document.getElementById(id);
        el.innerText = (val>0?'+':'') + val.toLocaleString('zh-CN', {minimumFractionDigits:2});
        el.className = 's-val ' + (val>=0 ? 'red' : 'green');
    }

    // --- ğŸ“Š å›¾è¡¨æ ¸å¿ƒé€»è¾‘ (ECharts + Iframe) ---

    function openChart(code, name) {
        currentChartCode = code;
        document.getElementById('chartModal').style.display = 'flex';
        document.getElementById('chart-name').innerText = name;
        // é»˜è®¤æ˜¾ç¤º Tab 1 (å†å²)
        switchTab(1);
    }

    function switchTab(tabIndex) {
        // åˆ‡æ¢æ ·å¼
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabIndex).classList.add('active');

        const echartView = document.getElementById('echart-view');
        const iframeView = document.getElementById('iframe-view');

        if(tabIndex === 1) {
            // æ˜¾ç¤º ECharts
            echartView.style.display = 'block';
            iframeView.style.display = 'none';
            loadHistoryChart(currentChartCode);
        } else {
            // æ˜¾ç¤º Iframe (ä»Šæ—¥å®æ—¶)
            echartView.style.display = 'none';
            iframeView.style.display = 'block';
            
            // åªæœ‰å½“ src ä¸ºç©ºæ—¶æ‰åŠ è½½ï¼Œé¿å…é‡å¤åˆ·æ–°
            // ä½¿ç”¨å¤©å¤©åŸºé‡‘å®˜æ–¹H5çš„ä¼°å€¼å›¾é¡µé¢
            const url = `https://h5.1234567.com.cn/pages/fund/gzdt/gzdt?fundCode=${currentChartCode}`;
            if(iframeView.src !== url) {
                iframeView.src = url;
            }
        }
    }

    function loadHistoryChart(code) {
        if(myChart) myChart.dispose();
        myChart = echarts.init(document.getElementById('echart-view'));
        myChart.showLoading({ text: 'æ•°æ®åŠ è½½ä¸­...', color: '#409eff' });

        // è·å–90å¤©å†å²å‡€å€¼
        const script = document.createElement('script');
        script.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?t=${Date.now()}`;
        
        script.onload = () => {
            try {
                if(typeof Data_netWorthTrend !== 'undefined' && Data_netWorthTrend.length > 0) {
                    const rawData = Data_netWorthTrend.slice(-90); 
                    const dates = rawData.map(item => {
                        const d = new Date(item.x);
                        return `${d.getMonth()+1}-${d.getDate()}`;
                    });
                    const values = rawData.map(item => item.y);

                    const option = {
                        tooltip: { trigger: 'axis', formatter: '{b} <br/> å‡€å€¼: {c}' },
                        grid: { top: 30, bottom: 30, left: 40, right: 20 },
                        xAxis: { type: 'category', data: dates, axisLine: {lineStyle:{color:'#ccc'}} },
                        yAxis: { type: 'value', scale: true, splitLine: {lineStyle:{color:'#eee'}} },
                        series: [{
                            data: values,
                            type: 'line',
                            smooth: true,
                            symbol: 'none',
                            lineStyle: { color: '#409eff', width: 2 },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                  { offset: 0, color: 'rgba(64,158,255,0.3)' },
                                  { offset: 1, color: 'rgba(64,158,255,0.01)' }
                                ])
                            }
                        }]
                    };
                    myChart.hideLoading();
                    myChart.setOption(option);
                }
            } catch(e) { console.error(e); }
        };
        document.body.appendChild(script);
    }

    function closeChart() {
        document.getElementById('chartModal').style.display = 'none';
        // æ¸…ç©ºiframeé˜²æ­¢åå°æ’­æ”¾æˆ–å ç”¨èµ„æº
        document.getElementById('iframe-view').src = '';
    }

    // --- ç¼–è¾‘/ä¿å­˜é€»è¾‘ ---
    function openEdit(idx) {
        editIdx = idx;
        const modal = document.getElementById('editModal');
        const delBtn = document.getElementById('btn-del');
        
        if(idx === -1) {
            document.getElementById('m-title').innerText = "æ·»åŠ åŸºé‡‘";
            document.getElementById('in-code').value = '';
            document.getElementById('in-share').value = '';
            document.getElementById('in-cost').value = '';
            document.getElementById('in-code').disabled = false;
            delBtn.style.display = 'none';
        } else {
            document.getElementById('m-title').innerText = "ä¿®æ”¹æŒä»“";
            const f = myFunds[idx];
            document.getElementById('in-code').value = f.code;
            document.getElementById('in-share').value = f.share;
            document.getElementById('in-cost').value = f.cost;
            document.getElementById('in-code').disabled = true;
            delBtn.style.display = 'block';
        }
        modal.style.display = 'flex';
    }

    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

    function doSave() {
        const code = document.getElementById('in-code').value.trim();
        const share = parseFloat(document.getElementById('in-share').value);
        const cost = parseFloat(document.getElementById('in-cost').value);
        if(!code || isNaN(share) || isNaN(cost)) return alert('ä¿¡æ¯ä¸å®Œæ•´');

        if(editIdx === -1) myFunds.push({code, share, cost});
        else { myFunds[editIdx].share = share; myFunds[editIdx].cost = cost; }

        localStorage.setItem('myFunds', JSON.stringify(myFunds));
        closeEdit();
        refreshData();
    }

    function doDel() {
        if(confirm('åˆ é™¤æ­¤åŸºé‡‘ï¼Ÿ')) {
            myFunds.splice(editIdx, 1);
            localStorage.setItem('myFunds', JSON.stringify(myFunds));
            closeEdit();
            renderList();
        }
    }

    // åˆå§‹åŒ–
    renderList();
    refreshData();
    setInterval(refreshData, 30000);

</script>
</body>
</html>
